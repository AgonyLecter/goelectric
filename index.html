<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Scooter GoElectric</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.0/fullcalendar.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f4f4;
            padding-top: 20px;
        }
        .logo {
            width: 150px;
            height: auto;
            margin-bottom: 20px;
        }
        #currentDateTime, #notifications {
            font-size: 18px;
            margin-bottom: 20px;
        }
        .scooter-btn {
            width: 100%;
            margin: 5px 0;
            font-size: 16px;
            font-weight: bold;
        }
        .btn-success { background-color: #28a745; }
        .return-today { background-color: #ffc107; }
        .btn-danger { background-color: #dc3545; }
        .out-of-service { background-color: #6c757d; }
        .modal-content { font-family: 'Roboto', sans-serif; }
        .fc-event { 
        white-space: normal; /* Permette al testo di andare a capo */
        overflow: hidden; /* Evita che il testo fuoriesca */
        height: auto; /* Adatta l'altezza automaticamente */
        min-height: 40px; /* Imposta un'altezza minima */
        font-size: 12px; /* Regola la dimensione del font per una migliore leggibilit√† */
    }
    </style>
</head>
<body>
    <div class="container d-flex flex-column align-items-center">
        <img src="logo.png" class="logo mb-3" alt="GoElectric Logo">
        <div id="navMenu" class="mb-3">
            <a href="reservations.html" class="btn btn-primary">Reservations</a>
            <button class="btn btn-info" id="calendarButton">Calendario</button>
        </div>
        <div id="currentDateTime"></div>
        <div id="notifications"></div>
        <div id="scooterList" class="w-100 row"></div>
        <div id="footer" class="mt-3 text-secondary"> &reg;ScrittoMatitato&Inchiostrato by MichaeldettoDamianodettoFabrizio </div>
    </div>

    <!-- Modals for managing scooters and calendar -->
    <div class="modal" tabindex="-1" role="dialog" id="manageScooterModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestisci Scooter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input id="daysInput" type="number" class="form-control" min="1" value="2">
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="returnToday">
                        <label class="form-check-label" for="returnToday">Rientra oggi</label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="outOfService">
                        <label class="form-check-label" for="outOfService">Non disponibile</label>
                    </div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="unlockScooter(currentScooterKey)">Sblocca</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitManage()">Conferma</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="calendarModal" tabindex="-1" role="dialog" aria-labelledby="calendarModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="calendarModalLabel">Calendario Scooter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.0/fullcalendar.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyC346gJHt-Dg7_bjzYw7k1D6j0tcalxht4",
            authDomain: "goelectric-e9299.firebaseapp.com",
            databaseURL: "https://goelectric-e9299-default-rtdb.firebaseio.com",
            projectId: "goelectric-e9299",
            storageBucket: "goelectric-e9299.appspot.com",
            messagingSenderId: "81618360543",
            appId: "1:81618360543:web:67a9a4d38ec18400c1316a",
            measurementId: "G-6FZQSDWEZJ"
        };
        firebase.initializeApp(firebaseConfig);

        const dbRef = firebase.database().ref('scooters');
        const reservationsRef = firebase.database().ref('reservations');
        let currentScooterKey;

        document.addEventListener('DOMContentLoaded', function() {
            setInterval(updateDateTime, 1000);
            checkTodayReservations();
            loadScooters();
            initCalendar();
            $('#calendarButton').on('click', function() {
                $('#calendarModal').modal('show');
            });
            midnightUpdate();
        });

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDateTime').textContent = now.toLocaleString('it-IT', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        function checkTodayReservations() {
    const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    reservationsRef.orderByChild('date').equalTo(today).on('value', snapshot => {
        const reservations = snapshot.val();
        if (reservations) {
            let messages = "<ul>"; // Usa un elenco HTML per visualizzare le prenotazioni
            for (let key in reservations) {
                const res = reservations[key];
                messages += `<li>${res.customerName} - ${res.scooterCount} scooter - Data: ${res.date} - Ora: ${res.time || "Non specificata"}`;
                if (res.delivery) {
                    messages += ` - Consegna: ${res.address || "Indirizzo non specificato"}`;
                }
                messages += "</li>";
            }
            messages += "</ul>";
            document.getElementById('notifications').innerHTML = messages;
        } else {
            document.getElementById('notifications').textContent = "Nessuna prenotazione per oggi.";
        }
    });
}


        function loadScooters() {
    dbRef.on('value', snapshot => {
        const data = snapshot.val();
        const container = document.getElementById('scooterList');
        container.innerHTML = '';
        Object.keys(data).sort((a, b) => a - b).forEach(key => {
            const scooter = data[key];
            const scooterButton = document.createElement('button');
            scooterButton.className = `btn ${getButtonClass(scooter.status)} scooter-btn`;
            scooterButton.textContent = `${scooter.name} - ${scooter.status} - Giorni rimasti: ${scooter.daysRemaining}`;
            if (scooter.pickupTime) { // Assicurati che pickupTime sia un campo nel tuo DB
                scooterButton.textContent += ` - Ritiro: ${scooter.pickupTime}`;
            }
            if (scooter.delivery) {
                scooterButton.textContent += ` - Consegna: ${scooter.deliveryAddress}`;
            }
            scooterButton.onclick = () => {
                currentScooterKey = key;
                showManageModal(scooter);
            };
            container.appendChild(scooterButton);
        });
    });
}


        function showManageModal(scooter) {
            document.getElementById('daysInput').value = scooter.daysRemaining || 2;
            document.getElementById('returnToday').checked = scooter.status === 'rientra_oggi';
            document.getElementById('outOfService').checked = scooter.status === 'non_disponibile';
            const manageModal = new bootstrap.Modal(document.getElementById('manageScooterModal'));
            manageModal.show();
        }

        function submitManage() {
            const daysInput = document.getElementById('daysInput');
            const days = parseInt(daysInput.value, 10);
            const returnToday = document.getElementById('returnToday').checked;
            const outOfService = document.getElementById('outOfService').checked;
            const updateObj = {
                status: outOfService ? 'non_disponibile' : returnToday ? 'rientra_oggi' : 'noleggiato',
                daysRemaining: returnToday || outOfService ? 0 : days
            };
            dbRef.child(currentScooterKey).update(updateObj).then(() => {
                const manageModal = bootstrap.Modal.getInstance(document.getElementById('manageScooterModal'));
                manageModal.hide();
            });
        }

        function unlockScooter(key) {
            dbRef.child(key).update({
                status: 'disponibile',
                daysRemaining: 0
            }).then(() => {
                alert('Scooter sbloccato con successo.');
                const manageModal = bootstrap.Modal.getInstance(document.getElementById('manageScooterModal'));
                manageModal.hide();
            });
        }

        function getButtonClass(status) {
            switch(status) {
                case 'disponibile': return 'btn-success';
                case 'rientra_oggi': return 'return-today';
                case 'non_disponibile': return 'out-of-service';
                default: return 'btn-danger';
            }
        }

        function initCalendar() {
    $('#calendar').fullCalendar({
        defaultView: $(window).width() < 765 ? 'agendaDay' : 'month',
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        height: 'auto',
        contentHeight: 'auto',
        aspectRatio: 1.35,
        events: loadEvents,
        eventClick: function(info) {
            if (info.event.extendedProps.details) {
                alert('Dettagli: ' + info.event.extendedProps.details);
            }
        },
        eventRender: function(event, element) {
            element.find('.fc-title').html(`<strong>${event.title}</strong>`); // Usa .html per garantire che tutto il titolo sia renderizzato correttamente
            // Tooltip per mostrare il titolo completo al passaggio del mouse
            $(element).tooltip({
                title: event.title + (event.extendedProps.details ? ": " + event.extendedProps.details : ""),
                placement: 'top'
            });
        },
        windowResize: function(view) {
            if ($(window).width() < 765) {
                $('#calendar').fullCalendar('changeView', 'agendaDay');
            } else {
                $('#calendar').fullCalendar('changeView', 'month');
            }
        }
    });
}


function loadEvents(start, end, timezone, callback) {
    dbRef.once('value').then(snapshot => {
        const events = [];
        snapshot.forEach(child => {
            const scooter = child.val();
            if (scooter.status !== 'disponibile' && scooter.name) { 
                const eventTitle = `Scooter ${scooter.name} - Ritiro: ${scooter.pickupTime || 'Non specificato'}`;
                const description = scooter.delivery ? `Consegna a: ${scooter.deliveryAddress}` : 'Nessuna consegna';
                events.push({
                    title: eventTitle,
                    start: moment().add(scooter.daysRemaining, 'days').startOf('day').toDate(),
                    end: moment().add(scooter.daysRemaining + 1, 'days').startOf('day').toDate(),
                    allDay: true,
                    color: getCalendarColor(scooter.status),
                    extendedProps: {
                        details: description
                    }
                });
            }
        });
        callback(events);
    });
}


function initCalendar() {
    $('#calendar').fullCalendar({
        defaultView: $(window).width() < 765 ? 'agendaDay' : 'month',
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        height: 'auto',
        contentHeight: 'auto',
        aspectRatio: 1.35,
        events: loadEvents,
        eventClick: function(info) {
            if (info.event.extendedProps.details) {
                alert('Dettagli: ' + info.event.extendedProps.details); // Mostra dettagli solo se presenti
            }
        },
        eventRender: function(event, element) {
            if (event.extendedProps.details) {
                element.find('.fc-title').append(`<br/>${event.extendedProps.details}`); // Mostra dettagli solo se presenti
            }
        },
        windowResize: function(view) {
            if ($(window). width() < 765) {
                $('#calendar').fullCalendar('changeView', 'agendaDay');
            } else {
                $('#calendar').fullCalendar('changeView', 'month');
            }
        }
    });
}



function getCalendarColor(status) {
    switch(status) {
        case 'rientra_oggi': return '#ffc107';
        case 'non_disponibile': return '#6c757d';
        case 'noleggiato': return '#dc3545';
        default: return '#28a745';
    }
}


        function midnightUpdate() {
            const now = new Date();
            const msUntilMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0) - now;
            setTimeout(function() {
                updateDaysRemaining();
                midnightUpdate(); // Schedule the next update
            }, msUntilMidnight);
        }

        function updateDaysRemaining() {
            dbRef.once('value', snapshot => {
                snapshot.forEach(child => {
                    const scooter = child.val();
                    if (scooter.daysRemaining > 0 && scooter.status !== 'non_disponibile') {
                        let newDaysRemaining = scooter.daysRemaining - 1;
                        let newStatus = newDaysRemaining === 0 ? 'disponibile' : scooter.status;
                        dbRef.child(child.key).update({
                            daysRemaining: newDaysRemaining,
                            status: newStatus
                        });
                    }
                });
            });
        }
    </script>
</body>
</html>
