<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Scooter GoElectric</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="logo.ico">
    <style>
        body {
            background-color: #f4f4f4;
            padding-top: 20px;
        }
        .logo {
            width: 150px;
            height: auto;
            margin-bottom: 20px;
        }
        #currentDateTime, #notifications {
            font-size: 18px;
            margin-bottom: 20px;
        }
        .scooter-btn {
            width: 100%;
            margin: 5px 0;
            font-size: 16px;
            font-weight: bold;
        }
        .btn-success { background-color: #28a745; }
        .return-today { background-color: #ffc107; }
        .btn-danger { background-color: #dc3545; }
        .out-of-service { background-color: #6c757d; }
        .modal-content { font-family: 'Roboto', sans-serif; }
    </style>
</head>
<body>
    <div class="container d-flex flex-column align-items-center">
        <img src="logo.png" class="logo mb-3" alt="GoElectric Logo">
        <div id="navMenu" class="mb-3">
            <a href="reservations.html" class="btn btn-primary">Reservations</a>
            <button class="btn btn-info" id="sortByReturnButton">Ordina per Rientri</button>
        </div>
        <div id="currentDateTime"></div>
        <div id="notifications">Prenotazioni di oggi:</div>
        <div id="scooterList" class="w-100 row"></div>
        <button class="btn btn-secondary mt-3" id="returnButton" style="display:none;">Torna alla vista principale</button>
        <div id="footer" class="mt-3 text-secondary"> &reg;Licenza Unica GoElectric </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog" id="manageScooterModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestisci Scooter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input id="daysInput" type="number" class="form-control" min="1" value="1">
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="returnToday">
                        <label class="form-check-label" for="returnToday">Rientra oggi</label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="outOfService">
                        <label class="form-check-label" for="outOfService">Non disponibile</label>
                    </div>
                    <div class="mt-2">
                        <label for="returnTime">Ora di Rientro:</label>
                        <input type="time" id="returnTime" class="form-control">
                    </div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="unlockScooter(currentScooterKey)">Sblocca</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitManage()">Conferma</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyC346gJHt-Dg7_bjzYw7k1D6j0tcalxht4",
            authDomain: "goelectric-e9299.firebaseapp.com",
            databaseURL: "https://goelectric-e9299-default-rtdb.firebaseio.com",
            projectId: "goelectric-e9299",
            storageBucket: "goelectric-e9299.appspot.com",
            messagingSenderId: "81618360543",
            appId: "1:81618360543:web:67a9a4d38ec18400c1316a",
            measurementId: "G-6FZQSDWEZJ"
        };
        firebase.initializeApp(firebaseConfig);

        const dbRefScooters = firebase.database().ref('scooters');
        const dbRefReservations = firebase.database().ref('reservations');

        document.addEventListener('DOMContentLoaded', function() {
            moment.tz.setDefault("Atlantic/Canary");
            setInterval(updateDateTime, 1000);
            checkAndUpdateScooters();
            checkTodayReservations();
            loadScooters();
            $('#sortByReturnButton').on('click', function() {
                displayScootersByReturnDate();
                $('#returnButton').show();
            });
            $('#returnButton').on('click', function() {
                returnToMainView();
            });
        });

        function checkAndUpdateScooters() {
            const now = moment();
            const todayMidnight = now.clone().startOf('day');

            dbRefScooters.once('value', snapshot => {
                if (!snapshot.exists()) {
                    console.log("No scooters found in database");
                    return;
                }
                const updates = {};
                snapshot.forEach(child => {
                    const scooter = child.val();
                    const lastUpdatedDate = moment(scooter.lastUpdated);
                    const lastUpdatedMidnight = lastUpdatedDate.clone().startOf('day');

                    if (lastUpdatedMidnight.isBefore(todayMidnight)) {
                        let updatedDaysRemaining = scooter.daysRemaining;
                        let updatedStatus = scooter.status;
                        let updatedReturnTime = scooter.returnTime || null;

                        if (updatedDaysRemaining > 0) {
                            updatedDaysRemaining -= 1;
                        }

                        if (updatedDaysRemaining === 0) {
                            if (updatedStatus === 'noleggiato') {
                                updatedStatus = 'rientra_oggi';
                            } else if (updatedStatus === 'rientra_oggi') {
                                updatedStatus = 'disponibile';
                                updatedReturnTime = null;
                            }
                        }

                        updates[child.key] = {
                            daysRemaining: updatedDaysRemaining,
                            status: updatedStatus,
                            lastUpdated: now.toISOString(),
                            returnTime: updatedReturnTime
                        };
                    }
                });

                if (Object.keys(updates).length > 0) {
                    dbRefScooters.update(updates)
                    .then(() => console.log('Scooters updated successfully'))
                    .catch(error => console.error('Error updating scooters:', error));
                }
            });
        }

        function checkTodayReservations() {
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            dbRefReservations.orderByChild('date').equalTo(today).on('value', snapshot => {
                const reservations = snapshot.val();
                const reservationsElement = document.getElementById('notifications');
                reservationsElement.innerHTML = 'Prenotazioni di oggi:';
                if (reservations) {
                    let listHtml = '<ul>';
                    for (let key in reservations) {
                        const res = reservations[key];
                        listHtml += `<li>${res.customerName} - ${res.scooterCount} scooter - ${res.date} alle ${res.time}, Consegna: ${res.delivery ? 'SÃ¬, a ' + res.address : 'No'}</li>`;
                    }
                    listHtml += '</ul>';
                    reservationsElement.innerHTML += listHtml;
                } else {
                    reservationsElement.innerHTML += ' Nessuna prenotazione per oggi.';
                }
            });
        }

function updateDateTime() {
    const now = new Date();
    document.getElementById('currentDateTime').textContent = now.toLocaleString('it-IT', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
}

function loadScooters() {
    dbRefScooters.orderByChild('name').on('value', snapshot => {
        if (!snapshot.exists()) {
            console.log("No scooters found.");
            return;
        }

        const data = snapshot.val();
        const container = document.getElementById('scooterList');
        container.innerHTML = '';
        Object.keys(data).forEach(key => {
            const scooter = data[key];
            const scooterButton = document.createElement('button');
            scooterButton.className = `btn ${getButtonClass(scooter.status)} scooter-btn`;
            let buttonText = `${scooter.name} - Giorni rimasti: ${scooter.daysRemaining}`;
            if (scooter.returnTime) {
                buttonText += `, Rientra alle: ${scooter.returnTime}`;
            }
            scooterButton.textContent = buttonText;
            scooterButton.onclick = () => {
                currentScooterKey = key;
                showManageModal(scooter);
            };
            container.appendChild(scooterButton);
        });
    });
}








        function formatScooterNumber(scooterName) {
            // Se il numero Ã¨ inferiore a 10, aggiungi lo zero iniziale
            const number = parseInt(scooterName.replace('scooter#', ''), 10);
            return number < 10 ? `0${number}` : `${number}`;
        }

        function displayScootersByReturnDate() {
    dbRefScooters.orderByChild('returnTime').on('value', snapshot => {
        const data = snapshot.val();
        const container = document.getElementById('scooterList');
        container.innerHTML = '';
        Object.keys(data).map(key => data[key])
            .sort((a, b) => {
                const statusPriority = {
                    'disponibile': 1,
                    'rientra_oggi': 2,
                    'noleggiato': 3,
                    'non_disponibile': 4
                };
                if (statusPriority[a.status] !== statusPriority[b.status]) {
                    return statusPriority[a.status] - statusPriority[b.status];
                }
                if (a.daysRemaining !== b.daysRemaining) {
                    return a.daysRemaining - b.daysRemaining;
                }
                return (a.returnTime || "").localeCompare(b.returnTime || "");
            })
            .forEach(scooter => {
                const scooterButton = document.createElement('button');
                scooterButton.className = `btn ${getButtonClass(scooter.status)} scooter-btn`;
                let buttonText = `${scooter.name} - Giorni rimasti: ${scooter.daysRemaining}`;
                if (scooter.returnTime) {
                    buttonText += `, Rientra alle: ${scooter.returnTime}`;
                }
                scooterButton.textContent = buttonText;
                scooterButton.onclick = () => {
                    currentScooterKey = key;
                    showManageModal(scooter);
                };
                container.appendChild(scooterButton);
            });
    });
}










        function returnToMainView() {
            loadScooters();
            $('#returnButton').hide();
        }

        function showManageModal(scooter) {
            document.getElementById('daysInput').value = scooter.daysRemaining || 1;
            document.getElementById('returnToday').checked = scooter.status === 'rientra_oggi';
            document.getElementById('outOfService').checked = scooter.status === 'non_disponibile';
            document.getElementById('returnTime').value = scooter.returnTime || ''; // Reset dell'input dell'orario di rientro
            const manageModal = new bootstrap.Modal(document.getElementById('manageScooterModal'));
            manageModal.show();
        }

        function submitManage() {
            const daysInput = document.getElementById('daysInput');
            const days = parseInt(daysInput.value, 10);
            const returnToday = document.getElementById('returnToday').checked;
            const outOfService = document.getElementById('outOfService').checked;
            const returnTimeInput = document.getElementById('returnTime');
            const returnTime = returnTimeInput.value ? returnTimeInput.value : null; // Prendi l'orario solo se fornito

            const updateObj = {
                status: outOfService ? 'non_disponibile' : returnToday ? 'rientra_oggi' : 'noleggiato',
                daysRemaining: returnToday || outOfService ? 0 : days,
                returnTime: returnTime // Aggiorna l'orario di rientro solo se fornito
            };

            dbRefScooters.child(currentScooterKey).update(updateObj).then(() => {
                const manageModal = bootstrap.Modal.getInstance(document.getElementById('manageScooterModal'));
                manageModal.hide();
                returnToMainView();
            });
        }

        function unlockScooter(key) {
    if (key) {
        dbRefScooters.child(key).update({
            status: 'disponibile',
            daysRemaining: 0,
            returnTime: null  
        }).then(() => {
            alert('Scooter sbloccato con successo.');
            const manageModal = bootstrap.Modal.getInstance(document.getElementById('manageScooterModal'));
            if (manageModal) {
                manageModal.hide();
            }
            returnToMainView();
        }).catch(error => {
            console.error('Errore durante lo sblocco dello scooter:', error);
        });
    } else {
        console.error('Chiave dello scooter non definita.');
    }
}


        function getButtonClass(status) {
            switch(status) {
                case 'disponibile': return 'btn-success';
                case 'rientra_oggi': return 'return-today';
                case 'non_disponibile': return 'out-of-service';
                default: return 'btn-danger';
            }
        }
    </script>
</body>
</html>



